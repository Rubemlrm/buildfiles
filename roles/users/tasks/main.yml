---
- name: Setup User
  become: true
  block:
    - name: Add system user
      user:
        name: '{{ username }}'
        password: "{{ password | password_hash('sha512') }}"
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa
        shell: '/usr/bin/zsh'
    - name: Created base folders for configs
      file: path={{ home_dir }}/{{ item }} state=directory mode=0755 owner={{ username }} group={{ username }}
      with_items:
        - 'tools'
        - 'bin'
        - '.local/share/fonts'
    - name: generate ssh config settings
      template:
        src: ssh_hosts.j2
        dest: '/home/{{username}}/.ssh/config'
        owner: '{{username}}'
        group: '{{username}}'
    - name: restore ssh keys
      copy:
        dest: '/home/{{username}}/.ssh/{{item.name}}_rsa'
        content: '{{item.private }}'
        owner: '{{username}}'
        group: '{{username}}'
        mode: '0600'
      with_items: "{{ ssh_hosts }}"
    - name: restore ssh keys
      copy:
        dest: '/home/{{username}}/.ssh/{{item.name}}_rsa.pub'
        content: '{{item.public}}'
        owner: '{{username}}'
        group: '{{username}}'
        mode: '0644'
      with_items: "{{ ssh_hosts }}"
    - name: Remove Users
      become: true
      user:
        name: '{{ item }}'
        state: absent
      with_items: '{{ disable_users }}'
      when: disable_users is defined
